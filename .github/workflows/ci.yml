name: CI Check

on:
  pull_request:
    branches: [main]      # feuert bei PR‑Ziel „main“
  workflow_dispatch:      # manueller Start

env:
  OUTPUT_DIR: output      # hier landen die .nupkg

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # wichtig für GitVersion!

      # .NET SDK
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # GitVersion
      - uses: gittools/actions/gitversion/setup@v3.2.1
        with:
          versionSpec: 6.3.x

      - id: gitversion
        uses: gittools/actions/gitversion/execute@v3.2.1
        with:
          useConfigFile: true

      - run: echo "Version ⇒ ${{ steps.gitversion.outputs.fullSemVer }}"

      # Restore / Build / Test
      - run: dotnet restore src/test.sln
      - run: dotnet build  src/test.sln -c Release --no-restore \
             /p:Version=${{ steps.gitversion.outputs.fullSemVer }}
      - run: dotnet test   src/test.sln -c Release --no-build

      # Pack Vorschau‑NuGet
      - run: |
          mkdir -p $OUTPUT_DIR
          dotnet pack src/test.sln -c Release --no-build \
            --output $OUTPUT_DIR \
            /p:PackageVersion=${{ steps.gitversion.outputs.fullSemVer }}

      # Artefakt hochladen (Auto‑Löschung nach 5 Tagen)
      - uses: actions/upload-artifact@v4
        with:
          name: preview-packages
          path: ${{ env.OUTPUT_DIR }}/*.nupkg
          retention-days: 5
